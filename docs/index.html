
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Biff</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen-2d4677d4.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-c427a123.css" rel="stylesheet" media="print" />
      <script src="javascripts/all-c5541673.js"></script>
  </head>

  <body class="index" data-languages="[&quot;Clojure&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
          </li>
          <li>
            <a href="#getting-started" class="toc-h1 toc-link" data-title="Getting started">Getting started</a>
          </li>
          <li>
            <a href="#build-system" class="toc-h1 toc-link" data-title="Build system">Build system</a>
          </li>
          <li>
            <a href="#backend-entrypoint" class="toc-h1 toc-link" data-title="Backend entrypoint">Backend entrypoint</a>
          </li>
          <li>
            <a href="#configuration" class="toc-h1 toc-link" data-title="Configuration">Configuration</a>
          </li>
          <li>
            <a href="#static-resources" class="toc-h1 toc-link" data-title="Static resources">Static resources</a>
          </li>
          <li>
            <a href="#authentication" class="toc-h1 toc-link" data-title="Authentication">Authentication</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#sign-up" class="toc-h2 toc-link" data-title="Sign up">Sign up</a>
                  </li>
                  <li>
                    <a href="#request-sign-in" class="toc-h2 toc-link" data-title="Request sign-in">Request sign-in</a>
                  </li>
                  <li>
                    <a href="#sign-in" class="toc-h2 toc-link" data-title="Sign in">Sign in</a>
                  </li>
                  <li>
                    <a href="#sign-out" class="toc-h2 toc-link" data-title="Sign out">Sign out</a>
                  </li>
                  <li>
                    <a href="#check-if-signed-in" class="toc-h2 toc-link" data-title="Check if signed in">Check if signed in</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href="https://github.com/jacobobryant/biff" target="_blank">View on Github</a></li>
            <li><a href="http://clojurians.net" target="_blank">Discuss on &#35;biff</a></li>
            <li><a href="https://findka.com/subscribe/" target="_blank">Subscribe for updates</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <div class="main-heading">
          <div class="main">Biff</div>
          <div class="sub">A web framework + self-hosted deployment solution for Clojure<br>
            <a href="https://jacobobryant.com" target="_blank"><small>Jacob O'Bryant</small></a></div>
        </div>
        <h1 id='introduction'>Introduction</h1>
<p>Biff is a web framework and self-hosted deployment solution for Clojure (<a
href="https://github.com/jacobobryant/biff" target="_blank">Github repo</a>).
It&#39;s the culmination of 18 months I&#39;ve spent building web apps with various
technologies like Datomic, Fulcro, AWS and Firebase (and plenty of Clojure
libraries). I&#39;ve taken parts I liked and added a few innovations of my own.
It&#39;s designed primarily to speed up development in pre-growth startups and hobby
projects, but over time I&#39;d like to make it suitable for apps that need scale
as well.</p>

<p>It includes features for:</p>

<ul>
<li>Automated <strong>installation and deploys</strong> on DigitalOcean.</li>
<li><a href="https://opencrux.com"><strong>Crux</strong></a> for the database. Thus you can use
filesystem persistence on a $5 droplet for hobby projects or managed
Postgres/Kafka for serious apps.</li>
<li><strong>Subscriptions</strong>. Specify what data the frontend needs declaratively, and
Biff will keep it up-to-date.</li>
<li><strong>Read/write authorization rules</strong>. No need to set up a bunch of endpoints
for CRUD operations. Queries and transactions can be submitted from the
frontend as long as they pass the rules you define.</li>
<li><strong>Database triggers</strong>. Run code when documents of certain types are created,
updated or deleted.</li>
<li><strong>Authentication</strong>. Email link for now; password and SSO coming later.</li>
<li><strong>Websocket communication</strong>.</li>
<li>Serving <strong>static resources</strong>.</li>
<li><strong>Multitenancy</strong>. Run multiple apps from the same process.</li>
</ul>

<p>Also: instead of trying to do everything for everyone, Biff is designed to be
easy to take apart (without forking). This should help mitigate the main
drawback of frameworks, which is that it&#39;s often less work in the long run to
just stitch the libraries together yourself.</p>

<p>Biff is currently <strong>alpha quality</strong>, though I am using it in production for <a
href="https://findka.com" target="_blank">Findka</a>. Join <code>#biff</code> on <a
href="http://clojurians.net" target="_blank">Clojurians Slack</a> for
discussion. I want to help people succeed with Biff, so feel free to ask for
help and let me know what I can improve. If you&#39;d like to support my work and
receive email updates about Biff, <a href="https://findka.com/subscribe/"
target="_blank">subscribe to my newsletter</a>.</p>
<h1 id='getting-started'>Getting started</h1>
<p>The fastest way to get started with Biff is by cloning the Github repo and running the
official example project (an implementation of Tic Tac Toe):</p>

<ol>
<li>Install dependencies (clj, npm and overmind)</li>
<li><code>git clone https://github.com/jacobobryant/biff</code></li>
<li><code>cd biff/example</code></li>
<li><code>./task setup</code></li>
<li><code>./task dev</code></li>
<li>Go to <code>localhost:9630</code> and start the <code>app</code> build</li>
<li>Go to <code>localhost:8080</code></li>
</ol>

<p>You can tinker with this app and use it as a template for your own projects.</p>
<h1 id='build-system'>Build system</h1>
<p>The example project uses tools.deps, Shadow CLJS, and Overmind.
<code>task</code> is the main entrypoint:</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/task" target="_blank">
task</a></div>
<div class="highlight"><pre class="highlight shell"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span>

setup <span class="o">()</span> <span class="o">{</span>
  which clj npm overmind <span class="o">&gt;</span> /dev/null <span class="c"># Assert dependencies</span>
  npm <span class="nb">install</span> <span class="c"># Or `npm init; npm install --save-dev shadow-cljs; npm install --save react react-dom`</span>
  clj <span class="nt">-Stree</span> <span class="o">&gt;</span> /dev/null <span class="c"># Download project dependencies</span>
<span class="o">}</span>

repl <span class="o">()</span> <span class="o">{</span>
  <span class="nv">BIFF_ENV</span><span class="o">=</span>dev clj <span class="nt">-m</span> biff.core
<span class="o">}</span>

cljs <span class="o">()</span> <span class="o">{</span>
  npx shadow-cljs server
<span class="o">}</span>

dev <span class="o">()</span> <span class="o">{</span>
  overmind start
<span class="o">}</span>

...

<span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div>
<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/Procfile" target="_blank">
Procfile</a></div>
<div class="highlight"><pre class="highlight shell tab-shell"><code>repl: ./task repl
cljs: ./task cljs
</code></pre></div>
<p>So <code>./task dev</code> will use Overmind to run <code>clj</code> and <code>shadow-cljs</code> in the same
terminal window. Hit <code>ctrl-c</code> to exit. If you&#39;d like to restart just one
process, run e.g. <code>overmind restart repl</code> in another window. You can easily add
new build tasks by creating new functions in <code>task</code>. Also, I recommend putting
<code>alias t=&#39;./task&#39;</code> in your <code>.bashrc</code>.</p>

<p>To fetch the latest Biff version, start out with only <code>:git/url</code> and <code>:tag</code> in the dependency:</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/deps.edn" target="_blank">
deps.edn</a></div>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">{</span><span class="n">...</span><span class="w">
 </span><span class="no">:deps</span><span class="w">
 </span><span class="p">{</span><span class="n">github-jacobobryant/biff</span><span class="w">
  </span><span class="p">{</span><span class="no">:git/url</span><span class="w"> </span><span class="s">"https://github.com/jacobobryant/biff"</span><span class="w">
   </span><span class="no">:tag</span><span class="w"> </span><span class="s">"HEAD"</span><span class="p">}}}</span><span class="w">
</span></code></pre></div>
<p>Then run <code>clj -Sresolve-tags</code>. The latest commit hash will be added to <code>deps.edn</code>.</p>
<h1 id='backend-entrypoint'>Backend entrypoint</h1>
<p>When you run <code>clj -m biff.core</code>, Biff searches the classpath for plugins and then starts
them in a certain order. To define a plugin, you must set <code>^:biff</code> metadata on a namespace
and then set a <code>components</code> var to a list of plugin objects in that namespace:</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/src/hello/core.clj" target="_blank">
src/hello/core.clj</a></div>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="o">^</span><span class="no">:biff</span><span class="w"> </span><span class="n">hello.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">biff.system</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">clojure.pprint</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">pprint</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">hello.handlers</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">hello.routes</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">hello.rules</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">hello.static</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">hello.triggers</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">send-email</span><span class="w"> </span><span class="p">[</span><span class="n">opts</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pprint</span><span class="w"> </span><span class="p">[</span><span class="no">:send-email</span><span class="w"> </span><span class="n">opts</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-hello</span><span class="w"> </span><span class="p">[</span><span class="n">sys</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">sys</span><span class="w">
    </span><span class="p">(</span><span class="nb">merge</span><span class="w"> </span><span class="o">#</span><span class="no">:hello.biff.auth</span><span class="p">{</span><span class="no">:send-email</span><span class="w"> </span><span class="n">send-email</span><span class="w">
                             </span><span class="no">:on-signup</span><span class="w"> </span><span class="s">"/signin/sent/"</span><span class="w">
                             </span><span class="no">:on-signin-request</span><span class="w"> </span><span class="s">"/signin/sent/"</span><span class="w">
                             </span><span class="no">:on-signin-fail</span><span class="w"> </span><span class="s">"/signin/fail/"</span><span class="w">
                             </span><span class="no">:on-signin</span><span class="w"> </span><span class="s">"/app/"</span><span class="w">
                             </span><span class="no">:on-signout</span><span class="w"> </span><span class="s">"/"</span><span class="p">})</span><span class="w">
    </span><span class="p">(</span><span class="nb">merge</span><span class="w"> </span><span class="o">#</span><span class="no">:hello.biff</span><span class="p">{</span><span class="no">:routes</span><span class="w"> </span><span class="n">hello.routes/routes</span><span class="w">
                        </span><span class="no">:static-pages</span><span class="w"> </span><span class="n">hello.static/pages</span><span class="w">
                        </span><span class="no">:event-handler</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">hello.handlers/api</span><span class="w"> </span><span class="n">%</span><span class="w"> </span><span class="p">(</span><span class="no">:?data</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w">
                        </span><span class="no">:rules</span><span class="w"> </span><span class="n">hello.rules/rules</span><span class="w">
                        </span><span class="no">:triggers</span><span class="w"> </span><span class="n">hello.triggers/triggers</span><span class="p">})</span><span class="w">
    </span><span class="p">(</span><span class="nf">biff.system/start-biff</span><span class="w"> </span><span class="ss">'hello.biff</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">components</span><span class="w">
  </span><span class="p">[{</span><span class="no">:name</span><span class="w"> </span><span class="no">:hello/core</span><span class="w">
    </span><span class="no">:requires</span><span class="w"> </span><span class="p">[</span><span class="no">:biff/init</span><span class="p">]</span><span class="w">
    </span><span class="no">:required-by</span><span class="w"> </span><span class="p">[</span><span class="no">:biff/web-server</span><span class="p">]</span><span class="w">
    </span><span class="no">:start</span><span class="w"> </span><span class="n">start-hello</span><span class="p">}])</span><span class="w">
</span></code></pre></div>
<p><code>:biff/init</code> and <code>:biff/web-server</code> are plugins defined in the <code>biff.core</code>
namespace. The <code>:requires</code> and <code>:required-by</code> values are used to start plugins
in the right order. You can think of plugins kind of like Ring middleware. They
receive a system map and pass along a modified version of it.</p>

<p><code>biff.system/start-biff</code> starts a Biff app. That includes initializing:</p>

<ul>
<li>a Crux node</li>
<li>a Sente websocket listener and event router</li>
<li>some default event handlers that handle queries, transactions and subscriptions from the frontend</li>
<li>a Crux transaction listener, so clients can be notified of subscription updates</li>
<li>some Reitit HTTP routes for authentication</li>
<li>any static resources you&#39;ve included with your app</li>
</ul>

<p>If you connect to nrepl port 7888, you can access the system with
<code>@biff.core/system</code>. Biff provides some helper functions for repl-driven
development:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="nf">biff.util/stop-system</span><span class="w"> </span><span class="o">@</span><span class="n">biff.core/system</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">biff.core/start</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">biff.core/refresh</span><span class="p">)</span><span class="w"> </span><span class="c1">; stops, reloads namespaces from filesystem, starts.</span><span class="w">
</span></code></pre></div><h1 id='configuration'>Configuration</h1>
<p>App-specific configuration can go in your plugin, as shown above. For example, we set
<code>:hello.biff.auth/on-signin</code> so that clients will be redirected to <code>/app/</code> after they
sign in successfully.</p>

<p>Environment-specific configuration and secrets can go in <code>config.edn</code>. They will be read in
by the <code>:biff/init</code> plugin.</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/config.edn" target="_blank">
config.edn</a></div>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">{</span><span class="no">:prod</span><span class="w"> </span><span class="p">{</span><span class="no">:biff.crux.jdbc/user</span><span class="w"> </span><span class="s">"..."</span><span class="w">
        </span><span class="no">:biff.crux.jdbc/password</span><span class="w"> </span><span class="s">"..."</span><span class="w">
        </span><span class="no">:biff.crux.jdbc/host</span><span class="w"> </span><span class="s">"..."</span><span class="w">
        </span><span class="no">:biff.crux.jdbc/port</span><span class="w"> </span><span class="n">...</span><span class="w">
        </span><span class="no">:hello.biff/host</span><span class="w"> </span><span class="s">"example.com"</span><span class="w">
        </span><span class="no">:hello.biff.crux.jdbc/dbname</span><span class="w"> </span><span class="s">"hello"</span><span class="w">
        </span><span class="no">:hello.mailgun/api-key</span><span class="w"> </span><span class="s">"..."</span><span class="p">}</span><span class="w">
 </span><span class="no">:dev</span><span class="w"> </span><span class="p">{</span><span class="no">:inherit</span><span class="w"> </span><span class="p">[</span><span class="no">:prod</span><span class="p">]</span><span class="w">
       </span><span class="no">:biff/dev</span><span class="w"> </span><span class="n">true</span><span class="w">
       </span><span class="no">:hello.biff/host</span><span class="w"> </span><span class="s">"localhost"</span><span class="p">}}</span><span class="w">
</span></code></pre></div>
<aside class="warning">Keep this file out of source control if it contains any secrets.</aside>

<p>The system map is mostly flat, with namespaced keys. For example, Biff
configuration for the example app is stored under the <code>:hello.biff</code> namespace.
You could run multiple Biff apps in the same process by using a different
namespace, e.g. <code>(biff.system/start-biff sys &#39;another-app.biff)</code>. Keys under
the <code>:biff</code> namespace (e.g. <code>:biff/dev</code> from <code>config.edn</code> above) will become
defaults for all Biff apps.</p>

<p>Similarly, the return values from <code>biff.system/start-biff</code> will be namespaced. For example,
you can get the Crux node in our example app with <code>(:hello.biff/node @biff.core/system)</code>.</p>

<p>When the <code>:biff/init</code> plugin reads in your <code>config.edn</code> file, it will merge the
nested maps according to the current environment and the value of <code>:inherit</code>.
The default environment is <code>:prod</code>. This can be overridden by setting the
<code>BIFF_ENV</code> environment variable:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="nv">BIFF_ENV</span><span class="o">=</span>dev clj <span class="nt">-m</span> biff.core
</code></pre></div>
<p>Here is a complete list of configuration options and their default values. See the following sections
for a deeper explanation.</p>

<p>Note: <code>:foo/*</code> is used to denote all keywords prefixed by <code>:foo/</code> or <code>:foo.</code>.</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="c1">; === Config for the :biff/init plugin ===</span><span class="w">

</span><span class="no">:biff.init/start-nrepl</span><span class="w"> </span><span class="n">true</span><span class="w">
</span><span class="no">:biff.init/nrepl-port</span><span class="w"> </span><span class="mi">7888</span><span class="w">
</span><span class="no">:biff.init/instrument</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="c1">; Calls orchestra.spec.test/instrument if true.</span><span class="w">
</span><span class="no">:timbre/*</span><span class="w"> </span><span class="n">...</span><span class="w">               </span><span class="c1">; These keys are passed to taoensso.timbre/merge-config!</span><span class="w">
                            </span><span class="c1">; (without the timbre prefix).</span><span class="w">


</span><span class="c1">; === Config for biff.system/start-biff ===</span><span class="w">
</span><span class="c1">; Note: app-ns is the second parameter in biff.system/start-biff</span><span class="w">

</span><span class="c1">; REQUIRED (unless you don't want to use the corresponding features)</span><span class="w">
</span><span class="no">:biff/host</span><span class="w"> </span><span class="n">nil</span><span class="w">          </span><span class="c1">; The hostname this app will be served on, e.g. "example.com" for prod</span><span class="w">
                        </span><span class="c1">; or "localhost" for dev.</span><span class="w">
</span><span class="no">:biff/static-pages</span><span class="w"> </span><span class="n">nil</span><span class="w">  </span><span class="c1">; A map from paths to Rum data structures, e.g.</span><span class="w">
                        </span><span class="c1">; {"/hello/" [:html [:body [:p "hello"]]]}</span><span class="w">
</span><span class="no">:biff/rules</span><span class="w"> </span><span class="n">nil</span><span class="w">         </span><span class="c1">; An authorization rules data structure.</span><span class="w">
</span><span class="no">:biff/fn-whitelist</span><span class="w"> </span><span class="n">nil</span><span class="w">  </span><span class="c1">; Collection of fully-qualified function symbols to allow in</span><span class="w">
                        </span><span class="c1">; Crux queries sent from the frontend. Functions in clojure.core</span><span class="w">
                        </span><span class="c1">; need not be qualified. For example: '[map? example.core/frobulate]</span><span class="w">
</span><span class="no">:biff/triggers</span><span class="w"> </span><span class="n">nil</span><span class="w">      </span><span class="c1">; A database triggers data structure.</span><span class="w">
</span><span class="no">:biff/event-handler</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="c1">; A Sente event handler function.</span><span class="w">
</span><span class="no">:biff/routes</span><span class="w"> </span><span class="n">nil</span><span class="w">        </span><span class="c1">; A vector of Reitit routes.</span><span class="w">

</span><span class="no">:biff.auth/send-email</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="c1">; A function.</span><span class="w">
</span><span class="no">:biff.auth/on-signup</span><span class="w"> </span><span class="n">nil</span><span class="w">  </span><span class="c1">; Redirect route, e.g. "/signup/success/".</span><span class="w">
</span><span class="no">:biff.auth/on-signin-request</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.auth/on-signin-fail</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.auth/on-signin</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.auth/on-signout</span><span class="w"> </span><span class="n">nil</span><span class="w">

</span><span class="c1">; Ignored if :biff.crux/topology isn't :jdbc.</span><span class="w">
</span><span class="no">:biff.crux.jdbc/user</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.crux.jdbc/password</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.crux.jdbc/host</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.crux.jdbc/port</span><span class="w"> </span><span class="n">nil</span><span class="w">

</span><span class="c1">; OPTIONAL</span><span class="w">
</span><span class="no">:biff/dev</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="c1">; When true, sets the following config options (overriding any specified values):</span><span class="w">
                </span><span class="c1">; {:biff.crux/topology :standalone</span><span class="w">
                </span><span class="c1">;  :biff.handler/secure-defaults false</span><span class="w">
                </span><span class="c1">;  :biff.static/root-dev "www-dev"}</span><span class="w">

</span><span class="no">:biff.crux/topology</span><span class="w"> </span><span class="no">:jdbc</span><span class="w"> </span><span class="c1">; One of #{:jdbc :standalone}</span><span class="w">
</span><span class="no">:biff.crux/storage-dir</span><span class="w"> </span><span class="s">"data/{{app-ns}}/crux-db"</span><span class="w"> </span><span class="c1">; Directory to store Crux files.</span><span class="w">
</span><span class="no">:biff.crux.jdbc/*</span><span class="w"> </span><span class="n">...</span><span class="w">     </span><span class="c1">; Passed to crux.api/start-node (without the biff prefix) if</span><span class="w">
                          </span><span class="c1">; :biff.crux/topology is :jdbc. In this case, you must set</span><span class="w">
                          </span><span class="c1">; :biff.crux.jdbc/{user,password,host,port}.</span><span class="w">
</span><span class="no">:biff.crux.jdbc/dbname</span><span class="w"> </span><span class="n">app-ns</span><span class="w">
</span><span class="no">:biff.crux.jdbc/dbtype</span><span class="w"> </span><span class="s">"postgresql"</span><span class="w">

</span><span class="no">:biff.static/root</span><span class="w"> </span><span class="s">"www/{{value of :biff/host}}"</span><span class="w"> </span><span class="c1">; Directory from which to serve static files.</span><span class="w">
</span><span class="no">:biff.static/root-dev</span><span class="w"> </span><span class="n">nil</span><span class="w">                       </span><span class="c1">; An additional static file directory.</span><span class="w">
</span><span class="no">:biff.static/resource-root</span><span class="w"> </span><span class="s">"www/{{app-ns}}"</span><span class="w">     </span><span class="c1">; Resource directory where static files are stored.</span><span class="w">

</span><span class="no">:biff.handler/not-found-path</span><span class="w"> </span><span class="s">"{{value of :biff.static/root}}/404.html"</span><span class="w">
</span><span class="no">:biff.handler/secure-defaults</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="c1">; Whether to use ring.middleware.defaults/secure-site-defaults</span><span class="w">
                                   </span><span class="c1">; or just site-defaults.</span><span class="w">


</span><span class="c1">; === Config for the :biff/web-server plugin ===</span><span class="w">

</span><span class="no">:biff.web/host-&gt;handler</span><span class="w"> </span><span class="n">...</span><span class="w"> </span><span class="c1">; Set by biff.system/start-biff. A map used to dispatch Ring</span><span class="w">
                            </span><span class="c1">; requests. For example:</span><span class="w">
                            </span><span class="c1">; {"localhost" (constantly {:status 200 ...})</span><span class="w">
                            </span><span class="c1">;  "example.com" (constantly {:status 200 ...})}</span><span class="w">
</span><span class="no">:biff.web/port</span><span class="w"> </span><span class="mi">8080</span><span class="w">         </span><span class="c1">; Port for the web server to listen on. Also used in</span><span class="w">
                            </span><span class="c1">; biff.system/start-biff.</span><span class="w">
</span></code></pre></div>
<p>The following keys are added to the system map by <code>biff.system/start-biff</code>:</p>

<ul>
<li><code>:biff/base-url</code>: e.g. <code>&quot;https://example.com&quot;</code> or <code>&quot;http://localhost:8080&quot;</code></li>
<li><code>:biff/node</code>: the Crux node.</li>
<li><code>:biff/send-event</code>: the value of <code>:send-fn</code> returned by <code>taoensso.sente/make-channel-socket!</code>.</li>
<li><code>:biff.sente/connected-uids</code>: Ditto but for <code>:connected-uids</code>.</li>
<li><code>:biff.crux/subscriptions</code>: An atom used to keep track of which clients have subscribed
to which queries.</li>
<li><code>:biff/submit-tx</code>: A replacement for <code>crux.api/submit-tx</code> that triggers subscription updates
(will be removed after <a href="https://github.com/jacobobryant/biff/issues/10" target="_blank">&#35;10</a>
is closed).</li>
</ul>

<p><code>biff.system/start-biff</code> merges the system map into incoming Ring requests and Sente events. It also
adds <code>:biff/db</code> (a Crux DB value) on each new request/event.
Note that
the keys will not be prefixed yet&mdash;so within a request/event handler, you&#39;d use <code>:biff/node</code> to get
the Crux node, but within a separate Biff plugin you&#39;d use e.g. <code>:example.biff/node</code>.</p>
<h1 id='static-resources'>Static resources</h1>
<p>Relevant config:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="no">:biff/static-pages</span><span class="w"> </span><span class="n">nil</span><span class="w">  </span><span class="c1">; A map from paths to Rum data structures, e.g.</span><span class="w">
                        </span><span class="c1">; {"/hello/" [:html [:body [:p "hello"]]]}</span><span class="w">

</span><span class="no">:biff.static/root</span><span class="w"> </span><span class="s">"www/{{value of :biff/host}}"</span><span class="w"> </span><span class="c1">; Directory from which to serve static files.</span><span class="w">
</span><span class="no">:biff.static/root-dev</span><span class="w"> </span><span class="n">nil</span><span class="w">                       </span><span class="c1">; An additional static file directory.</span><span class="w">
</span><span class="no">:biff.static/resource-root</span><span class="w"> </span><span class="s">"www/{{app-ns}}"</span><span class="w">     </span><span class="c1">; Resource directory where static files are stored.</span><span class="w">

</span><span class="no">:biff/dev</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="c1">; When true, sets the following config options (overriding any specified values):</span><span class="w">
                </span><span class="c1">; {:biff.static/root-dev "www-dev"</span><span class="w">
                </span><span class="c1">;  ...}</span><span class="w">
</span></code></pre></div>
<p>Biff will copy your static resources to <code>www/yourwebsite.com/</code> (i.e. the value
of <code>:biff.static/root</code>). In production, <code>www/</code> is a symlink to <code>/var/www/</code> and
is served directly by Nginx (so static files will be served even if your JVM
process goes down, e.g. during deployment). In development, the JVM process
will serve files from that directory.</p>

<p>Biff gets static resources from two places. First, it will render HTML
files from the value of <code>:biff/static-pages</code> on startup.</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/src/hello/static.clj" target="_blank">
src/hello/static.clj</a></div>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">hello.static</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">rum.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">rum</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">signin-form</span><span class="w">
  </span><span class="p">(</span><span class="nf">rum/fragment</span><span class="w">
    </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"Email address:"</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="no">:form</span><span class="w"> </span><span class="p">{</span><span class="no">:action</span><span class="w"> </span><span class="s">"/api/signin-request"</span><span class="w"> </span><span class="no">:method</span><span class="w"> </span><span class="s">"post"</span><span class="p">}</span><span class="w">
     </span><span class="p">[</span><span class="no">:input</span><span class="w"> </span><span class="p">{</span><span class="no">:name</span><span class="w"> </span><span class="s">"email"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="s">"email"</span><span class="w"> </span><span class="no">:placeholder</span><span class="w"> </span><span class="s">"Email"</span><span class="p">}]</span><span class="w">
     </span><span class="p">[</span><span class="no">:button</span><span class="w"> </span><span class="p">{</span><span class="no">:type</span><span class="w"> </span><span class="s">"submit"</span><span class="p">}</span><span class="w"> </span><span class="s">"Sign up/Sign in"</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">home</span><span class="w">
  </span><span class="p">[</span><span class="no">:html</span><span class="w">
   </span><span class="p">[</span><span class="no">:head</span><span class="w">
    </span><span class="p">[</span><span class="no">:meta</span><span class="w"> </span><span class="p">{</span><span class="no">:charset</span><span class="w"> </span><span class="s">"utf-8"</span><span class="p">}]</span><span class="w">
    </span><span class="p">[</span><span class="no">:script</span><span class="w"> </span><span class="p">{</span><span class="no">:src</span><span class="w"> </span><span class="s">"/js/ensure-signed-out.js"</span><span class="p">}]]</span><span class="w">
   </span><span class="p">[</span><span class="no">:body</span><span class="w">
    </span><span class="n">signin-form</span><span class="p">]])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">signin-sent</span><span class="w">
  </span><span class="p">[</span><span class="no">:html</span><span class="w"> </span><span class="p">[</span><span class="no">:head</span><span class="w"> </span><span class="p">[</span><span class="no">:meta</span><span class="w"> </span><span class="p">{</span><span class="no">:charset</span><span class="w"> </span><span class="s">"utf-8"</span><span class="p">}]]</span><span class="w">
   </span><span class="p">[</span><span class="no">:body</span><span class="w">
    </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"Sign-in link sent, please check your inbox."</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"(Just kidding: click on the sign-in link that was printed to the console.)"</span><span class="p">]]])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">signin-fail</span><span class="w">
  </span><span class="p">[</span><span class="no">:html</span><span class="w"> </span><span class="p">[</span><span class="no">:head</span><span class="w"> </span><span class="p">[</span><span class="no">:meta</span><span class="w"> </span><span class="p">{</span><span class="no">:charset</span><span class="w"> </span><span class="s">"utf-8"</span><span class="p">}]]</span><span class="w">
   </span><span class="p">[</span><span class="no">:body</span><span class="w">
    </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"Invalid sign-in token."</span><span class="p">]</span><span class="w">
    </span><span class="n">signin-form</span><span class="p">]])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">app</span><span class="w">
  </span><span class="p">[</span><span class="no">:html</span><span class="w">
   </span><span class="p">[</span><span class="no">:head</span><span class="w">
    </span><span class="p">[</span><span class="no">:meta</span><span class="w"> </span><span class="p">{</span><span class="no">:charset</span><span class="w"> </span><span class="s">"utf-8"</span><span class="p">}]</span><span class="w">
    </span><span class="p">[</span><span class="no">:script</span><span class="w"> </span><span class="p">{</span><span class="no">:src</span><span class="w"> </span><span class="s">"/js/ensure-signed-in.js"</span><span class="p">}]]</span><span class="w">
   </span><span class="p">[</span><span class="no">:body</span><span class="w">
    </span><span class="p">[</span><span class="no">:#app</span><span class="w"> </span><span class="s">"Loading..."</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="no">:script</span><span class="w"> </span><span class="p">{</span><span class="no">:src</span><span class="w"> </span><span class="s">"/cljs/app/main.js"</span><span class="p">}]]])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">not-found</span><span class="w">
  </span><span class="p">[</span><span class="no">:html</span><span class="w"> </span><span class="p">[</span><span class="no">:head</span><span class="w"> </span><span class="p">[</span><span class="no">:meta</span><span class="w"> </span><span class="p">{</span><span class="no">:charset</span><span class="w"> </span><span class="s">"utf-8"</span><span class="p">}]]</span><span class="w">
   </span><span class="p">[</span><span class="no">:body</span><span class="w">
    </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"Not found."</span><span class="p">]]])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">pages</span><span class="w">
  </span><span class="p">{</span><span class="s">"/"</span><span class="w"> </span><span class="n">home</span><span class="w">
   </span><span class="s">"/signin/sent/"</span><span class="w"> </span><span class="n">signin-sent</span><span class="w">
   </span><span class="s">"/signin/fail/"</span><span class="w"> </span><span class="n">signin-fail</span><span class="w">
   </span><span class="s">"/app/"</span><span class="w"> </span><span class="n">app</span><span class="w">
   </span><span class="s">"/404.html"</span><span class="w"> </span><span class="n">not-found</span><span class="p">})</span><span class="w">
</span></code></pre></div>
<p>Second, Biff will look for files in the resource directory specified
by <code>:biff.static/resource-root</code>.</p>
<div class="highlight"><pre class="highlight shell"><code>biff/example <span class="nv">$ </span>tree resources/
resources/
└── www
    └── hello.biff
        └── js
            ├── ensure-signed-in.js
            └── ensure-signed-out.js
</code></pre></div>
<p>I currently commit generated resources (except for HTML files, but including
CLJS compilation output) to the git repo. If you prefer, you can easily add
initialization code to your app that instead generates the resources during
deployment (or downloads them from a CI server).</p>

<p>I&#39;d like to add a CDN integration eventually.</p>
<h1 id='authentication'>Authentication</h1>
<p>Relevant config:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="no">:biff.auth/send-email</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="c1">; A function.</span><span class="w">
</span><span class="no">:biff.auth/on-signup</span><span class="w"> </span><span class="n">nil</span><span class="w">  </span><span class="c1">; Redirect route, e.g. "/signup/success/".</span><span class="w">
</span><span class="no">:biff.auth/on-signin-request</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.auth/on-signin-fail</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.auth/on-signin</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span><span class="no">:biff.auth/on-signout</span><span class="w"> </span><span class="n">nil</span><span class="w">
</span></code></pre></div>
<p>Biff currently provides email link authentication (i.e. the user clicks a link
in an email to sign in). Password and SSO authentication are on the roadmap.</p>

<p>Biff provides a set of HTTP endpoints for authentication.</p>
<h2 id='sign-up'>Sign up</h2>
<p>Sends the user an email with a sign-in link. Redirects to the value of
<code>:biff.auth/on-signup</code>. If the email is sent successfully and the user
hasn&#39;t already signed up, creates a user
document in Crux with the email and a random UUID.</p>

<p>The token included in the link will expire after 30 minutes.</p>
<h3 id='http-request'>HTTP Request</h3>
<p><code>POST /api/signup</code></p>
<h3 id='form-parameters'>Form Parameters</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>email</td>
<td>The user&#39;s email address.</td>
</tr>
</tbody></table>
<h3 id='example-usage'>Example Usage</h3><div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"Email address:"</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="no">:form</span><span class="w"> </span><span class="p">{</span><span class="no">:action</span><span class="w"> </span><span class="s">"/api/signup"</span><span class="w"> </span><span class="no">:method</span><span class="w"> </span><span class="s">"post"</span><span class="p">}</span><span class="w">
 </span><span class="p">[</span><span class="no">:input</span><span class="w"> </span><span class="p">{</span><span class="no">:name</span><span class="w"> </span><span class="s">"email"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="s">"email"</span><span class="w"> </span><span class="no">:placeholder</span><span class="w"> </span><span class="s">"Email"</span><span class="p">}]</span><span class="w">
 </span><span class="p">[</span><span class="no">:button</span><span class="w"> </span><span class="p">{</span><span class="no">:type</span><span class="w"> </span><span class="s">"submit"</span><span class="p">}</span><span class="w"> </span><span class="s">"Sign up"</span><span class="p">]]</span><span class="w">
</span></code></pre></div>
<p>The <code>:biff.auth/send-email</code> function will be called with the following options:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="nf">send-email</span><span class="w"> </span><span class="p">{</span><span class="no">:to</span><span class="w"> </span><span class="s">"alice@example.com"</span><span class="w">
             </span><span class="no">:template</span><span class="w"> </span><span class="no">:biff.auth/signup</span><span class="w">
             </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:biff.auth/link</span><span class="w"> </span><span class="s">"https://example.com/api/signin?token=..."</span><span class="p">}})</span><span class="w">
</span></code></pre></div>
<p>You will have to provide a <code>send-email</code> function which generates an email from
the template data and sends it. (The example app just prints the template data
to the console). If you use Mailgun, you can do something like this:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">templates</span><span class="w">
  </span><span class="p">{</span><span class="no">:biff.auth/signup</span><span class="w">
   </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">biff.auth/link</span><span class="w"> </span><span class="n">to</span><span class="p">]}]</span><span class="w">
     </span><span class="p">{</span><span class="no">:subject</span><span class="w"> </span><span class="s">"Thanks for signing up"</span><span class="w">
      </span><span class="no">:html</span><span class="w"> </span><span class="p">(</span><span class="nf">rum.core/render-static-markup</span><span class="w">
              </span><span class="p">[</span><span class="no">:div</span><span class="w">
               </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"We received a request to sign up with Findka using this email address."</span><span class="p">]</span><span class="w">
               </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="p">[</span><span class="no">:a</span><span class="w"> </span><span class="p">{</span><span class="no">:href</span><span class="w"> </span><span class="n">link</span><span class="p">}</span><span class="w"> </span><span class="s">"Click here to sign up."</span><span class="p">]]</span><span class="w">
               </span><span class="p">[</span><span class="no">:p</span><span class="w"> </span><span class="s">"If you did not request this link, you can ignore this email."</span><span class="p">]])})</span><span class="w">
   </span><span class="no">:biff.auth/signin</span><span class="w"> </span><span class="n">...</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">send-email*</span><span class="w"> </span><span class="p">[</span><span class="n">api-key</span><span class="w"> </span><span class="n">opts</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">http/post</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"https://api.mailgun.net/v3/mail.example.com/messages"</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="no">:basic-auth</span><span class="w"> </span><span class="p">[</span><span class="s">"api"</span><span class="w"> </span><span class="n">api-key</span><span class="p">]</span><span class="w">
     </span><span class="no">:form-params</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="no">:from</span><span class="w"> </span><span class="s">"Example &lt;contact@mail.example.com&gt;"</span><span class="p">)}))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">send-email</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">to</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">api-key</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">opts</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">some?</span><span class="w"> </span><span class="n">template</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">if-some</span><span class="w"> </span><span class="p">[</span><span class="n">template-fn</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="n">template</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="nf">send-email*</span><span class="w"> </span><span class="n">api-key</span><span class="w">
        </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="p">(</span><span class="nf">template-fn</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="no">:to</span><span class="w"> </span><span class="n">to</span><span class="p">))</span><span class="w"> </span><span class="no">:to</span><span class="w"> </span><span class="n">to</span><span class="p">))</span><span class="w">
      </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Email template not found:"</span><span class="w"> </span><span class="n">template</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">send-email*</span><span class="w"> </span><span class="n">api-key</span><span class="w"> </span><span class="p">(</span><span class="nb">select-keys</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="p">[</span><span class="no">:to</span><span class="w"> </span><span class="no">:subject</span><span class="w"> </span><span class="no">:text</span><span class="w"> </span><span class="no">:html</span><span class="p">]))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-example</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">example.mailgun/api-key</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">sys</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">sys</span><span class="w">
    </span><span class="p">(</span><span class="nb">merge</span><span class="w">
      </span><span class="p">{</span><span class="no">:example.biff.auth/send-email</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">send-email</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">%</span><span class="w"> </span><span class="no">:api-key</span><span class="w"> </span><span class="n">api-key</span><span class="p">))</span><span class="w">
       </span><span class="n">...</span><span class="p">})</span><span class="w">
    </span><span class="p">(</span><span class="nf">biff.system/start-biff</span><span class="w"> </span><span class="ss">'example.biff</span><span class="p">)))</span><span class="w">
</span></code></pre></div><h2 id='request-sign-in'>Request sign-in</h2>
<p>Sends the user an email with a sign-in link. This is the same as <a href="#sign-up">Sign up</a>,
except:</p>

<ul>
<li>The endpoint is <code>/api/signin-request</code></li>
<li>The template key will be set to <code>:biff.auth/signin</code></li>
<li>The user will be redirected to the value of <code>:biff.auth/on-signin-request</code></li>
</ul>
<h2 id='sign-in'>Sign in</h2>
<p>Verifies the given JWT and adds a <code>:uid</code> key to the user&#39;s session (expires in
90 days). Redirects to the value of <code>:biff.auth/on-signin</code> (or
<code>:biff.auth/on-signin-fail</code> if the token is incorrect or expired).</p>

<p>Also sets a <code>:csrf</code> cookie, the value of which must be included in the
<code>X-CSRF-Token</code> header for any HTTP requests that require authentication.</p>
<h3 id='http-request-2'>HTTP Request</h3>
<p><code>GET /api/signin</code></p>
<h3 id='url-parameters'>URL Parameters</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>token</td>
<td>A JWT</td>
</tr>
</tbody></table>
<h3 id='example-usage-2'>Example Usage</h3>
<p>This endpoint is used by the link generated by <a href="#sign-up">Sign up</a> and <a href="#request-sign-in">Request
sign-in</a>, so you typically won&#39;t need to generate a link for
this endpoint yourself. However, if you&#39;d like to use a longer expiration date for the
token or authenticate at a custom endpoint, you can do it like so:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="nf">biff.util/token-url</span><span class="w"> </span><span class="p">{</span><span class="no">:url</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="no">:biff/base-url</span><span class="w"> </span><span class="n">sys</span><span class="p">)</span><span class="w"> </span><span class="s">"/api/unsubscribe"</span><span class="p">)</span><span class="w">
                      </span><span class="no">:claims</span><span class="w"> </span><span class="p">{</span><span class="no">:email</span><span class="w"> </span><span class="s">"alice@example.com"</span><span class="w">
                               </span><span class="no">:uid</span><span class="w"> </span><span class="s">"abc123"</span><span class="p">}</span><span class="w">
                      </span><span class="no">:jwt-secret</span><span class="w"> </span><span class="p">(</span><span class="nf">biff.auth/jwt-key</span><span class="w"> </span><span class="n">sys</span><span class="p">)</span><span class="w">
                      </span><span class="no">:iss</span><span class="w"> </span><span class="s">"example"</span><span class="w">
                      </span><span class="no">:expires-in</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">4</span><span class="p">)})</span><span class="w">

</span><span class="c1">; Or for just the token:</span><span class="w">
</span><span class="p">(</span><span class="nf">biff.util/mint</span><span class="w"> </span><span class="p">{</span><span class="no">:secret</span><span class="w"> </span><span class="p">(</span><span class="nf">biff.auth/jwt-key</span><span class="w"> </span><span class="n">sys</span><span class="p">)</span><span class="w">
                 </span><span class="no">:iss</span><span class="w"> </span><span class="s">"example"</span><span class="w">
                 </span><span class="no">:expires-in</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">4</span><span class="p">)}</span><span class="w">
                </span><span class="p">{</span><span class="no">:email</span><span class="w"> </span><span class="s">"alice@example.com"</span><span class="w">
                 </span><span class="no">:uid</span><span class="w"> </span><span class="s">"abc123"</span><span class="p">})</span><span class="w">
</span></code></pre></div>
<p>After a user is signed in, you can authenticate them on the backend from an event/request
handler like so:</p>
<div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">session/uid</span><span class="w"> </span><span class="n">biff/db</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">some?</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">prn</span><span class="w"> </span><span class="p">(</span><span class="nf">crux.api/entity</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="p">{</span><span class="no">:user/id</span><span class="w"> </span><span class="n">uid</span><span class="p">}))</span><span class="w">
    </span><span class="c1">; =&gt; {:crux.db/id {:user/id #uuid "..."}</span><span class="w">
    </span><span class="c1">;     :user/id #uuid "..." ; duplicated for query convenience</span><span class="w">
    </span><span class="c1">;     :user/email "alice@example.com"}</span><span class="w">
    </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"User not authenticated."</span><span class="p">)))</span><span class="w">
</span></code></pre></div><h2 id='sign-out'>Sign out</h2>
<p>Clears the user&#39;s session and <code>:csrf</code> cookie. Redirects to the value of
<code>:biff.auth/on-signout</code>.</p>

<p>See <a href="https://github.com/jacobobryant/biff/issues/26" target="_blank">#26</a>.</p>
<h3 id='http-request-3'>HTTP Request</h3>
<p><code>GET /api/signout</code></p>
<h3 id='example-usage-3'>Example Usage</h3><div class="highlight"><pre class="highlight clojure tab-clojure"><code><span class="p">[</span><span class="no">:a</span><span class="w"> </span><span class="p">{</span><span class="no">:href</span><span class="w"> </span><span class="s">"/api/signout"</span><span class="p">}</span><span class="w"> </span><span class="s">"sign out"</span><span class="p">]</span><span class="w">
</span></code></pre></div><h2 id='check-if-signed-in'>Check if signed in</h2>
<p>Returns status 200 if the user is authenticated, else 403.</p>

<p>See <a href="https://github.com/jacobobryant/biff/issues/26" target="_blank">#26</a>.</p>
<h3 id='http-request-4'>HTTP Request</h3>
<p><code>GET /api/signed-in</code></p>
<h3 id='example-usage-4'>Example Usage</h3>
<p>Include this on your landing page:</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/resources/www/hello.biff/js/ensure-signed-out.js" target="_blank">
resources/www/hello.biff/js/ensure-signed-out.js</a></div>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/signed-in</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/app</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>Include this on your app page:</p>

<div class="file-heading"><a href="https://github.com/jacobobryant/biff/blob/master/example/resources/www/hello.biff/js/ensure-signed-in.js" target="_blank">
resources/www/hello.biff/js/ensure-signed-in.js</a></div>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/signed-in</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="Clojure">Clojure</a>
          </div>
      </div>
    </div>
  </body>
</html>
